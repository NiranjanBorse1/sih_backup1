<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Safety Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- IMPORTANT: The 'places' library is added here, which is required for the find nearby buttons to work -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6crVsRPttlbmx8JnxO6pvr3ifvQI7n5c&libraries=places,drawing&callback=initApp" async defer></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 400px; border-radius: 1rem; margin-top: 1.5rem; }
        .service-btn { transition: all 0.2s ease-in-out; }
        #sos-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        #sos-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(220, 38, 38, 0.4);
        }
    </style>
</head>
<body class="bg-gray-100">

    <button id="sos-btn" class="bg-red-600 text-white rounded-full p-5 shadow-lg flex items-center justify-center hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
        <span class="ml-3 font-bold text-xl">SOS</span>
    </button>
    
    <div class="container mx-auto p-4 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                <h1 class="text-3xl font-bold text-gray-800">Safety Portal Registration</h1>
                <p class="text-gray-600 mb-6">Verify your identity to activate real-time safety features.</p>
                <form id="touristForm" class="space-y-4">
                    <input type="text" id="name" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Full Name">
                    <input type="text" id="digitalId" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Digital ID / Passport No.">
                    <input type="text" id="emergencyContactName" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Emergency Contact Name">
                    <input type="tel" id="emergencyContactPhone" required class="w-full px-4 py-3 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Emergency Contact Phone">
                    <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition">Verify & Activate Tracking</button>
                    <p id="locationStatus" class="text-sm text-center text-gray-500">Fetching location...</p>
                </form>
                <div id="statusContainer" class="mt-6 space-y-3">
                    <p class="text-center text-gray-500">Verification status will appear here.</p>
                </div>
            </div>

            <div class="lg:col-span-3 bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800">Live Map & Nearby Services</h2>
                <div class="flex flex-wrap gap-2 mt-4">
                    <button onclick="findNearby('hospital')" class="service-btn flex-1 bg-red-100 text-red-800 font-semibold py-2 px-4 rounded-lg hover:bg-red-200">Find Hospitals</button>
                    <button onclick="findNearby('police')" class="service-btn flex-1 bg-blue-100 text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200">Find Police</button>
                    <button onclick="findNearby('tourist_attraction')" class="service-btn flex-1 bg-green-100 text-green-800 font-semibold py-2 px-4 rounded-lg hover:bg-green-200">Attractions</button>
                </div>
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
    let map, userMarker, infoWindow, placesService;
    let userLocation = null;
    let userInfo = {};
    let serviceMarkers = [];
    let geofencePolygon = null;
    let persistedPolygons = [];

        function initApp() {
            map = new google.maps.Map(document.getElementById('map'), { center: { lat: 18.5204, lng: 73.8567 }, zoom: 14, mapTypeControl: false, streetViewControl: false });
            infoWindow = new google.maps.InfoWindow();
            placesService = new google.maps.places.PlacesService(map);
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    document.getElementById('locationStatus').textContent = 'âœ… Location ready.';
                    userMarker = new google.maps.Marker({ position: userLocation, map: map, title: "Your Location", icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeColor: "white", strokeWeight: 2 } });
                    map.setCenter(userLocation);
                }, () => handleLocationError(true));
            } else { handleLocationError(false); }
        }
        
        document.getElementById('touristForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            userInfo = {
                name: document.getElementById('name').value,
                digitalId: document.getElementById('digitalId').value,
                emergencyContact: { name: document.getElementById('emergencyContactName').value, phone: document.getElementById('emergencyContactPhone').value }
            };
            if (!userLocation || !userInfo.name || !userInfo.digitalId) { alert('Please ensure all fields are filled and location is enabled.'); return; }
            
            const userData = { ...userInfo, location: userLocation };
            document.getElementById('statusContainer').innerHTML = '';
            await Promise.all([ callAIService(userData), callBlockchainService(userData) ]);
            
            document.getElementById('sos-btn').classList.remove('hidden');
            startRealTimeTracking();
            fetchAndDrawGeofence();
        });

        document.getElementById('sos-btn').addEventListener('click', () => {
            if (confirm("CONFIRM EMERGENCY: This will immediately notify authorities of your location. Are you sure?")) {
                alert("SOS Alert Sent! Authorities have been notified. Stay in a safe location if possible.");
                fetch('http://127.0.0.1:3002/alerts/sos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user: userInfo, location: userLocation })
                });
            }
        });

        function startRealTimeTracking() {
            setInterval(() => {
                navigator.geolocation.getCurrentPosition(pos => {
                    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    if(userMarker) userMarker.setPosition(userLocation);
                    fetch('http://127.0.0.1:3002/geofence/check', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ touristId: userInfo.digitalId, coords: { lat: userLocation.lat, lng: userLocation.lng } })
                    }).catch(()=>{});
                });
            }, 10000);
        }

        async function fetchAndDrawGeofence() {
            try {
                const response = await fetch('http://127.0.0.1:3002/geofence/all');
                const data = await response.json();
                const geofences = data?.data?.geofences || [];
                // Clear existing persisted polygons
                persistedPolygons.forEach(p => p.setMap(null));
                persistedPolygons = [];
                geofences.forEach(g => {
                    const coords = (g.polygon.coordinates[0] || []).map(([lng,lat]) => ({ lat, lng }));
                    const poly = new google.maps.Polygon({ paths: coords, strokeColor: "#FF0000", strokeOpacity: 0.8, strokeWeight: 2, fillColor: "#FF0000", fillOpacity: 0.25 });
                    poly.setMap(map);
                    persistedPolygons.push(poly);
                });
            } catch (error) {
                console.error("Could not fetch geofence:", error);
            }
        }

        // --- FULLY FUNCTIONAL NEARBY SEARCH ---
        function findNearby(type) {
            if (!userLocation) {
                alert("Cannot search for nearby places until your location is determined.");
                return;
            }
            
            const request = {
                location: userLocation,
                radius: '5000', // search within a 5km radius
                type: [type]
            };

            placesService.nearbySearch(request, (results, status) => {
                clearServiceMarkers(); // Clear old markers before showing new ones
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    for (let i = 0; i < results.length; i++) {
                        createMarkerForPlace(results[i], type);
                    }
                } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                    alert(`No results found for ${type.replace('_', ' ')} nearby.`);
                } else {
                    console.error("Places service failed with status:", status);
                }
            });
        }

        function createMarkerForPlace(place, type) {
            if (!place.geometry || !place.geometry.location) return;

            const icons = {
                hospital: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                police: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                tourist_attraction: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png'
            };

            const marker = new google.maps.Marker({
                map: map,
                position: place.geometry.location,
                icon: icons[type] || 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
            });
            
            serviceMarkers.push(marker);

            google.maps.event.addListener(marker, 'click', () => {
                infoWindow.setContent(`<strong>${place.name}</strong><br>${place.vicinity || ''}`);
                infoWindow.open(map, marker);
            });
        }
        
        function clearServiceMarkers() {
            for (let i = 0; i < serviceMarkers.length; i++) {
                serviceMarkers[i].setMap(null);
            }
            serviceMarkers = [];
        }
        
        function handleLocationError(browserHasGeolocation) {
            document.getElementById('locationStatus').textContent = browserHasGeolocation ? 'Error: Geolocation service failed. Please enable location permissions.' : 'Error: Your browser doesn\'t support geolocation.';
        }
        
        const createStatusCard = (title, message, success) => { document.getElementById('statusContainer').insertAdjacentHTML('beforeend', `<div class="p-3 rounded-lg ${success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}"><p class="font-bold">${title}</p><p class="text-sm">${message}</p></div>`); };
        const callAIService = (data) => fetch('http://127.0.0.1:5001/analyze', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)}).then(res => res.json()).then(result => createStatusCard('AI Analysis', `${result.message} (Risk: ${result.riskScore})`, result.riskScore < 50));
        const callBlockchainService = async (data) => {
            try {
                const payload = {
                    name: data.name,
                    nationality: 'UNKNOWN',
                    phoneNumber: data.emergencyContact?.phone || '',
                    emergencyContact: data.emergencyContact?.phone || ''
                };
                const res = await fetch('http://127.0.0.1:3001/blockchain/registerDeID', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const result = await res.json();
                const txId = (result?.data?.touristId || result?.data?.message || 'registered').toString();
                createStatusCard('Blockchain Registration', `ID: ${txId.substring(0,20)}...`, true);
            } catch (e) {
                createStatusCard('Blockchain Registration', 'Failed to contact blockchain-service', false);
            }
        };
    </script>
</body>
</html>

